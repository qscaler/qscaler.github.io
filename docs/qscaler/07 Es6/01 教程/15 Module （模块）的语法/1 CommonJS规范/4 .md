<!--
 * @Author              : qxp
 * @Date                : 2021-09-29 14:53:54
 * @LastEditors         : Please set LastEditors
 * @LastEditTime        : 2021-09-29 15:01:33
 * @FilePath            : \new\6 Es6\15 Module （模块）的语法\1 CommonJS规范\4、.html
-->

### 一

CommonJS 模块系统是同步加载的

1. 、CommonJS 模块规范的好处
   CommonJS 模块规范很好地解决变量污染问题，每个模块具有独立空间，互不干扰，命名空间等方案与之相比相形见绌。
   CommonJS 规范定义模块十分简单，接口十分简洁。
   CommonJS 模块规范支持引入和导出功能，这样可以顺畅地连接各个模块，实现彼此间的依赖关系。

    2013 年 5 月，**Node.js 的包管理器 NPM 的作者 Isaac Z. Schlueter 说 CommonJS 已经过时，Node.js 的内核开发者已经废弃了该规范**

2. commonJS 使用 exports 导出模块， require 导入模块
   具体规范如下：

    1. **如果 js 文件中存在 exports 或 require，该 js 文件 是一个模块**。
    2. 模块内的所有代码均为 隐藏代码，包括 全局变量、全局函数，这些全局的内容 均不应该对全局变量造成污染。
    3. 如果一个模块需要暴露一些 API 给外部使用，需要通过 exports 导出，exports 是一个空对象，你可以为该对象 添加任何需要导出的内容。
    4. 如果一个模块需要导入其他模块，通过 require 实现，require 是一个函数，传入模块的路径即可返回该模块导出的整个内容。

3. nodes 对 CommonJS 的实现
   为了实现 CommonJS 规范， nodejs 对模块 做出了以下处理

    1. 为了保证高效的执行，进加载必要的模块。nodejs 执行到 require 函数时才会加载并执行。
    2. 为了隐藏模块中的代码，nodejs 执行模块时，会将模块中的所有放到一个函数中执行，以保证不污染全局变量。

    ```js
    ;(function () {
        // 模块中的代码
    })()
    ```

    3. 为了保证顺利的导出模块内容，nodejs 做了以下处理
        1. 在模块开始执行前，初始化一个值 module.exports = {}
        2. module.exports 是模块导出之
        3. 为了方便开发者便捷的导出，nodejs 在初始化 完成 module.exports 后，有声明了一个变量 exports = module.exports

    ```js
    ;(function (module) {
        module.exports = {}
        var exports = module.exports
        // a.js 写入的代码
        exports.a = 'a'

        return module.exports
    })()

    // 所以 我们可以在 a.js 写法
    exports.a = 'a'
    // 或
    module.exports = {
        a: 'a',
    }
    // or
    module.exports = 'a' // 在index.js 打印 就是 a

    // 注意 无效
    exports = 'a'
    ```

4.为了避免反复加载同一个模块，nodejs 默认开启了模块缓存功能，如果已经加载过的模块，则会自动使用之前的导出结果。

    ```js
      // a.js
      console.log('a 模块加载')
      module.exports = 'a'

      // b.js 		b模块中依赖a模块
      console.log('b 模块加载')
      const moduleA = require('./a.js');

      module.exports = 'b'

      // index.js 入口文件 依赖 a模块 和 b模块
      const moduleA = require('./a.js');
      const moduleB = require('./b.js');
      // 打印结果为：

      // a 模块加载
      // b 模块加载
    ```
